{
  "version": 3,
  "sources": [
    "barsHandler.server.js"
  ],
  "names": [
    "require",
    "load",
    "yelp",
    "client",
    "process",
    "env",
    "YELP_FUSION_APIKEY",
    "Pub",
    "User",
    "barsHandler",
    "getBars",
    "req",
    "res",
    "term",
    "headers",
    "termdata",
    "location",
    "locationdata",
    "limit",
    "limitdata",
    "offset",
    "offsetdata",
    "search",
    "then",
    "result",
    "end",
    "body",
    "catch",
    "e",
    "console",
    "log",
    "dateFilter",
    "attendedBy",
    "attendedByFiltered",
    "filter",
    "attendee",
    "nextMidnight",
    "Date",
    "now",
    "date",
    "dateInMilliseconds",
    "dayMilliseconds",
    "Math",
    "ceil",
    "getAttendees",
    "barId",
    "bariddata",
    "findOne",
    "exec",
    "err",
    "pub",
    "filteredArr",
    "length",
    "toString",
    "attendBar",
    "username",
    "user",
    "github",
    "newDate",
    "nameMatch",
    "pubMatch",
    "id",
    "subdoc",
    "subdocFound",
    "i",
    "index",
    "findIndex",
    "splice",
    "findOneAndUpdate",
    "$set",
    "push",
    "newPub",
    "save",
    "doc",
    "filteredPubs",
    "attending",
    "barIdFound",
    "module",
    "exports"
  ],
  "mappings": "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",
  "file": "barsHandler.server.js",
  "sourceRoot": "../../../src/app/controllers",
  "sourcesContent": [
    "'use strict'\r\n\r\nrequire(\"dotenv\").load()\r\nvar yelp = require('yelp-fusion')\r\nvar client = yelp.client(process.env.YELP_FUSION_APIKEY)\r\nvar Pub = require(\"../models/pubs.js\")\r\nvar User = require(\"../models/users.js\")\r\n\r\n\r\nfunction barsHandler() {\r\n    this.getBars = function(req, res) {\r\n        var term = req.headers.termdata\r\n        var location = req.headers.locationdata\r\n        var limit = req.headers.limitdata\r\n        var offset = req.headers.offsetdata\r\n        client.search({\r\n            term: term,\r\n            location: location,\r\n            limit: limit,\r\n            offset: offset\r\n        }).then(function(result) {\r\n            res.end(result.body)\r\n        }).catch(function(e) {\r\n            console.log(e);\r\n        })\r\n    }\r\n    var dateFilter = function(attendedBy) {\r\n        var attendedByFiltered = attendedBy.filter(function(attendee) {\r\n            return nextMidnight(Date.now()) == nextMidnight(attendee.date)\r\n        })\r\n        return attendedByFiltered\r\n    }\r\n    var nextMidnight = function(dateInMilliseconds) {\r\n        var dayMilliseconds = 1000 * 60 * 60 * 24\r\n        return Math.ceil(dateInMilliseconds / dayMilliseconds) * dayMilliseconds\r\n    }\r\n    this.getAttendees = function(req, res) {\r\n        var barId = req.headers.bariddata\r\n        Pub.findOne({'id': barId})\r\n        .exec(function(err, pub) {\r\n            if (err) throw err\r\n            if (pub) {\r\n                var filteredArr = dateFilter(pub.attendedBy)\r\n                res.end(filteredArr.length.toString(10))\r\n            } else {\r\n                res.end('0')\r\n            }\r\n        })\r\n    }\r\n    this.attendBar = function(req, res) {\r\n        var username = req.user.github.username\r\n        var barId = req.headers.bariddata\r\n        var newDate = Date.now()\r\n        var nameMatch = function(attendee) {\r\n            return attendee.username == username\r\n        }\r\n        var pubMatch = function(pub) {\r\n            return pub.id == barId\r\n        }\r\n        Pub.findOne({'id': barId})\r\n        .exec(function(err, pub) {\r\n            if (err) throw err\r\n            if (pub) {\r\n                var subdoc = dateFilter(pub.attendedBy)\r\n                var subdocFound = false\r\n                for (let i in subdoc) {\r\n                    if (subdoc[i].username == username) {\r\n                        subdocFound = true\r\n                        break\r\n                    }\r\n                }\r\n                if (subdocFound) {\r\n                    //remove user from attendedBy array and update, then return array length\r\n                    var index = subdoc.findIndex(nameMatch)\r\n                    subdoc.splice(index, 1)\r\n                    Pub.findOneAndUpdate({'id': barId}, { $set: { attendedBy: subdoc }}, function(err) {\r\n                        if (err) throw err\r\n                    })\r\n                } else {\r\n                    subdoc.push({username: username, date: newDate})\r\n                    Pub.findOneAndUpdate({'id': barId}, { $set: { attendedBy: subdoc }}, function(err) {\r\n                        if (err) throw err\r\n                    })\r\n                }\r\n                res.end(subdoc.length.toString(10))\r\n            } else {\r\n                var newPub = new Pub()\r\n                newPub.id = barId\r\n                newPub.attendedBy.push({username: username, date: newDate})\r\n                \r\n                newPub.save(function (err, doc) {\r\n                    if (err) throw err\r\n                })\r\n                res.end(newPub.attendedBy.length.toString(10))\r\n            }\r\n        })\r\n                \r\n        User.findOne({'github.username': username})\r\n        .exec(function(err, attendee) {\r\n            if (err) throw err\r\n            if (attendee) {\r\n                var filteredPubs = dateFilter(attendee.attending)\r\n                var barIdFound = false\r\n                for (let i in filteredPubs) {\r\n                    if (filteredPubs[i].id == barId) {\r\n                        barIdFound = true\r\n                        break\r\n                    }\r\n                }\r\n                if (barIdFound) {\r\n                    var index = filteredPubs.findIndex(pubMatch)\r\n                    filteredPubs.splice(index, 1)\r\n                } else {\r\n                    filteredPubs.push({id: barId, date: newDate})\r\n                }\r\n                User.findOneAndUpdate({'github.username': username}, { $set: { attending: filteredPubs }}, function(err) {\r\n                    if (err) throw err\r\n                })\r\n            }\r\n        })\r\n    }\r\n}\r\nmodule.exports = barsHandler"
  ]
}
