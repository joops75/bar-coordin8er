{
  "version": 3,
  "sources": [
    "barsHandler.server.js"
  ],
  "names": [
    "require",
    "load",
    "Yelp",
    "yelp",
    "id",
    "process",
    "env",
    "YELP_FUSION_KEY",
    "secret",
    "YELP_FUSION_SECRET",
    "Pub",
    "User",
    "barsHandler",
    "getBars",
    "req",
    "res",
    "term",
    "headers",
    "termdata",
    "location",
    "locationdata",
    "limit",
    "limitdata",
    "offset",
    "offsetdata",
    "search",
    "then",
    "result",
    "json",
    "dateFilter",
    "attendedBy",
    "attendedByFiltered",
    "filter",
    "attendee",
    "nextMidnight",
    "Date",
    "now",
    "date",
    "dateInMilliseconds",
    "dayMilliseconds",
    "Math",
    "ceil",
    "getAttendees",
    "barId",
    "bariddata",
    "findOne",
    "exec",
    "err",
    "pub",
    "filteredArr",
    "end",
    "length",
    "toString",
    "attendBar",
    "username",
    "user",
    "github",
    "newDate",
    "nameMatch",
    "pubMatch",
    "subdoc",
    "subdocFound",
    "i",
    "index",
    "findIndex",
    "splice",
    "findOneAndUpdate",
    "$set",
    "push",
    "newPub",
    "save",
    "doc",
    "filteredPubs",
    "attending",
    "barIdFound",
    "module",
    "exports"
  ],
  "mappings": "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",
  "file": "barsHandler.server.js",
  "sourceRoot": "../../../src/app/controllers",
  "sourcesContent": [
    "'use strict'\n\nrequire(\"dotenv\").load()\nvar Yelp = require('node-yelp-fusion')\nvar yelp = new Yelp({ id: process.env.YELP_FUSION_KEY, secret: process.env.YELP_FUSION_SECRET })\nvar Pub = require(\"../models/pubs.js\")\nvar User = require(\"../models/users.js\")\n\n\nfunction barsHandler() {\n    this.getBars = function(req, res) {\n        var term = req.headers.termdata\n        var location = req.headers.locationdata\n        var limit = req.headers.limitdata\n        var offset = req.headers.offsetdata\n        yelp.search(\"https://api.yelp.com/v3/businesses/search&term=\" + term + \"&location=\" + location + \"&categories=bars&limit=\" + limit + \"&offset=\" + offset)\n            .then(function(result){\n                   res.json(result)\n                })\n    }\n    var dateFilter = function(attendedBy) {\n        var attendedByFiltered = attendedBy.filter(function(attendee) {\n            return nextMidnight(Date.now()) == nextMidnight(attendee.date)\n        })\n        return attendedByFiltered\n    }\n    var nextMidnight = function(dateInMilliseconds) {\n        var dayMilliseconds = 1000 * 60 * 60 * 24\n        return Math.ceil(dateInMilliseconds / dayMilliseconds) * dayMilliseconds\n    }\n    this.getAttendees = function(req, res) {\n        var barId = req.headers.bariddata\n        Pub.findOne({'id': barId})\n        .exec(function(err, pub) {\n            if (err) throw err\n            if (pub) {\n                var filteredArr = dateFilter(pub.attendedBy)\n                res.end(filteredArr.length.toString(10))\n            } else {\n                res.end('0')\n            }\n        })\n    }\n    this.attendBar = function(req, res) {\n        var username = req.user.github.username\n        var barId = req.headers.bariddata\n        var newDate = Date.now()\n        var nameMatch = function(attendee) {\n            return attendee.username == username\n        }\n        var pubMatch = function(pub) {\n            return pub.id == barId\n        }\n        Pub.findOne({'id': barId})\n        .exec(function(err, pub) {\n            if (err) throw err\n            if (pub) {\n                var subdoc = dateFilter(pub.attendedBy)\n                var subdocFound = false\n                for (let i in subdoc) {\n                    if (subdoc[i].username == username) {\n                        subdocFound = true\n                        break\n                    }\n                }\n                if (subdocFound) {\n                    //remove user from attendedBy array and update, then return array length\n                    var index = subdoc.findIndex(nameMatch)\n                    subdoc.splice(index, 1)\n                    Pub.findOneAndUpdate({'id': barId}, { $set: { attendedBy: subdoc }}, function(err) {\n                        if (err) throw err\n                    })\n                } else {\n                    subdoc.push({username: username, date: newDate})\n                    Pub.findOneAndUpdate({'id': barId}, { $set: { attendedBy: subdoc }}, function(err) {\n                        if (err) throw err\n                    })\n                }\n                res.end(subdoc.length.toString(10))\n            } else {\n                var newPub = new Pub()\n                newPub.id = barId\n                newPub.attendedBy.push({username: username, date: newDate})\n                \n                newPub.save(function (err, doc) {\n                    if (err) throw err\n                })\n                res.end(newPub.attendedBy.length.toString(10))\n            }\n        })\n                \n        User.findOne({'github.username': username})\n        .exec(function(err, attendee) {\n            if (err) throw err\n            if (attendee) {\n                var filteredPubs = dateFilter(attendee.attending)\n                var barIdFound = false\n                for (let i in filteredPubs) {\n                    if (filteredPubs[i].id == barId) {\n                        barIdFound = true\n                        break\n                    }\n                }\n                if (barIdFound) {\n                    var index = filteredPubs.findIndex(pubMatch)\n                    filteredPubs.splice(index, 1)\n                } else {\n                    filteredPubs.push({id: barId, date: newDate})\n                }\n                User.findOneAndUpdate({'github.username': username}, { $set: { attending: filteredPubs }}, function(err) {\n                    if (err) throw err\n                })\n            }\n        })\n    }\n}\nmodule.exports = barsHandler"
  ]
}
